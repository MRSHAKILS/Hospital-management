{% extends 'partials/base.html' %} {% block content %}
<section class="container">
  <div class="row d-flex justify-content-center mt-3">
    <div class="col-lg-6">
      <div class="shadow p-3 rounded-3">
        <h3 class="mb-4">Bio Data</h3>
        <div class="row">
          <div class="col-lg-12 mb-3">
            <label for="name" class="mb-2">Full Name</label>
            <input
              type="text"
              value="{{billing.patient.full_name}}"
              readonly
              class="form-control bg-light"
            />
          </div>
          <div class="col-lg-6 mb-3">
            <label for="name" class="mb-2">Email</label>
            <input
              type="text"
              value="{{billing.patient.email}}"
              readonly
              class="form-control bg-light"
            />
          </div>
          <div class="col-lg-6 mb-3">
            <label for="name" class="mb-2">Mobile Number</label>
            <input
              type="text"
              value="{{billing.patient.mobile}}"
              readonly
              class="form-control bg-light"
            />
          </div>
          <div class="col-lg-6 mb-3">
            <label for="name" class="mb-2">Gender</label>
            <input
              type="text"
              value="{{billing.patient.gender}}"
              readonly
              class="form-control bg-light"
            />
          </div>
          <div class="col-lg-6 mb-3">
            <label for="name" class="mb-2">Date Of Birth</label>
            <input
              type="text"
              value="{{billing.patient.dob}}"
              readonly
              class="form-control bg-light"
            />
          </div>
          <div class="col-lg-12 mb-3">
            <label for="name" class="mb-2">Address</label>
            <input
              type="text"
              value="{{billing.patient.address}}"
              readonly
              class="form-control bg-light"
            />
          </div>
        </div>
      </div>

      <div class="shadow p-3 rounded-3 mt-4">
        <h3 class="mb-4">Doctor Description</h3>
        <div class="d-flex">
          <div class="col-12 col-lg-5">
            <img
              class="img-fluid mt-4"
              style="
                width: 100%;
                height: 450px;
                object-fit: cover;
                border-radius: 10px;
              "
              src="{{billing.appointment.doctor.image.url}}"
              alt=""
            />
          </div>

          <div class="col-12 col-lg-7 p-4 rounded-3 bg-white">
            <h3 class="fw-bold mt-5">
              <span class=""
                ><b>Dr. {{billing.appointment.doctor.full_name}}</b></span
              >
            </h3>
            <p class="fs-5 mt-4">
              {{billing.appointment.doctor.bio|default:""}}
            </p>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="shadow p-3 rounded-3">
        <div class="d-flex justify-content-between">
          <p class="fw-semibold fs-5">Sub-total</p>
          <p class="fs-5">${{billing.sub_total}}</p>
        </div>

        <div class="d-flex justify-content-between">
          <p class="fw-semibold fs-5">VAT</p>
          <p class="fs-5">${{billing.tax}}</p>
        </div>

        <div class="d-flex justify-content-between">
          <p class="fw-bold fs-4">Total</p>
          <p class="fw-bold fs-4">${{billing.total}}</p>
        </div>
        <div class="mt-4">
          <!-- Simple Pay Now Button -->
          <button
            type="button"
            id="pay-now-button"
            class="btn btn-success text-white w-100 mb-3"
          >
            Pay Now <i class="fas fa-credit-card ms-2"></i>
          </button>

          <!-- Stripe Button (Keep for display only) -->
          <button
            type="button"
            id="stripe-payment"
            class="btn text-white w-100 mb-3"
            style="background-color: blueviolet"
            disabled
            title="Stripe payment temporarily unavailable"
          >
            Pay With Stripe <i class="fas fa-credit-card ms-2"></i>
          </button>

          <!-- PayPal Button Container (Keep for display only) -->
          <div id="paypal-button-container" class="mt-3">
            <button
              class="btn btn-warning w-100"
              disabled
              title="PayPal payment temporarily unavailable"
            >
              Pay with PayPal <i class="fab fa-paypal ms-2"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Keep the PayPal and Stripe scripts for future use -->
<script src="https://www.paypal.com/sdk/js?client-id=test&currency=USD"></script>
<script src="https://js.stripe.com/v3/"></script>

<script>
  // Simple Pay Now functionality
  document
    .getElementById("pay-now-button")
    .addEventListener("click", function () {
      const button = this;
      const originalText = button.innerHTML;

      // Show processing state
      button.innerHTML =
        'Processing Payment... <i class="fas fa-spinner fa-spin ms-2"></i>';
      button.disabled = true;

      // Make request to process payment
      fetch("/pay_now/{{billing.billing_id}}/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({
          billing_id: "{{billing.billing_id}}",
          amount: "{{billing.total}}",
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            // Redirect to payment status page
            window.location.href = `/payment_status/${data.billing_id}/?payment_status=paid`;
          } else {
            // Handle error
            window.location.href = `/payment_status/{{billing.billing_id}}/?payment_status=failed`;
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          // Reset button state
          button.innerHTML = originalText;
          button.disabled = false;
          alert("Payment processing failed. Please try again.");
        });
    });

  // Function to get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Keep original Stripe code (disabled for now)
  var stripe = Stripe("{{stripe_public_key}}");
  var checkoutButton = document.getElementById("stripe-payment");

  // Stripe functionality disabled
  /*
  try {
    checkoutButton.addEventListener("click", function () {
      var email = "{{billing.patient.email}}";

      checkoutButton.innerHTML =
        "Processing <i class='fas fa-spinner fa-spin ms-2'></i>";

      fetch("/stripe_payment/{{billing.billing_id}}/", {
        method: "POST",
        body: JSON.stringify({ email: email }),
      })
        .then(function (response) {
          return response.json();
        })
        .then(function (session) {
          return stripe.redirectToCheckout({ sessionId: session.sessionId });
        })
        .then(function (result) {
          if (result.error) {
            alert(result.error.message);
          }
        })
        .catch(function (error) {
          console.log("Error: ", error);
        });
    });
  } catch (error) {
    console.log(error);
  }
  */

  // PayPal functionality disabled
  /*
  function initPayPalButton() {
    paypal
      .Buttons({
        style: {
          shape: "rect",
          color: "gold",
          layout: "vertical",
          label: "paypal",
        },

        createOrder: function (data, actions) {
          return actions.order.create({
            purchase_units: [
              { amount: { currency_code: "USD", value: "{{billing.total}}" } },
            ],
          });
        },

        onApprove: function (data, actions) {
          return actions.order.capture().then(function (orderData) {
            console.log(
              "Capture result",
              orderData,
              JSON.stringify(orderData, null, 2)
            );

            const element = document.getElementById("paypal-button-container");
            element.innerHTML = "";
            element.innerHTML = "<h5>Verifying payment...</h5>";
            window.location.href = `/paypal_payment_verify/{{billing.billing_id}}/?transaction_id=${orderData.id}`;
          });
        },

        onError: function (err) {
          console.log(err);
        },
      })
      .render("#paypal-button-container");
  }
  initPayPalButton();
  */
</script>
{% endblock content %}
